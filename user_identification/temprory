<?php
include 'database.php';

?>

<!DOCTYPE html>
<html>
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">

  <title>Posts</title>
</head>
<body>
  <!-- Fetch posts from the database -->
  <?php
  $sql = "SELECT * FROM post";
  $result = mysqli_query($conn, $sql);

  if (mysqli_num_rows($result) > 0) {
      echo "<table class='table'>";
      echo "<thead>";
      echo "<tr>";
      echo "<th>Post ID</th>";
      echo "<th>First Name</th>";
      echo "<th>Last Name</th>";
      echo "<th>Email</th>";
      echo "<th>Message</th>";
      echo "<th>File</th>";
      echo "<th>Meta Data</th>";
      echo "</tr>";
      echo "</thead>";
      echo "<tbody>";

      while ($row = mysqli_fetch_assoc($result)) {
          $post_id = $row['id'];
          $first_name = $row['first_name'];
          $last_name = $row['last_name'];
          $email = $row['email'];
          $msg = $row['msg'];
          $file = $row['file'];

          // Fetch meta data for the post
          $meta_sql = "SELECT meta_key, meta_value FROM meta_post WHERE post_id = $post_id";
          $meta_result = mysqli_query($conn, $meta_sql);

          $meta_data = array();
          if (mysqli_num_rows($meta_result) > 0) {
              while ($meta_row = mysqli_fetch_assoc($meta_result)) {
                  $meta_key = $meta_row['meta_key'];
                  $meta_value = $meta_row['meta_value'];

                  $meta_data[$meta_key] = $meta_value;
              }
          }

          // Display the post details
          echo "<tr>";
          echo "<td>$post_id</td>";
          echo "<td>$first_name</td>";
          echo "<td>$last_name</td>";
          echo "<td>$email</td>";
          echo "<td>$msg</td>";
          echo "<td><a href='$file'>$file</a></td>";

          // Display the meta data
          echo "<td>";
          if (!empty($meta_data)) {
              foreach ($meta_data as $meta_key => $meta_value) {
                  echo "<p>$meta_key: $meta_value</p>";
              }
          } else {
              echo "No meta data found.";
          }
          echo "</td>";

          echo "</tr>";
      }

      echo "</tbody>";
      echo "</table>";
  } else {
      echo "<p>No posts found.</p>";
  }

  mysqli_close($conn);
  ?>

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
</body>
</html>
-------------------------
<?php
include 'database.php';
include 'header.php';

// Check if the form is submitted
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Get the updated data from the form
    $post_id = $_POST['post_id'];
    $first_name = $_POST['first_name'];
    $last_name = $_POST['last_name'];
    $email = $_POST['email'];
    $msg = $_POST['msg'];
    $file = $_POST['file'];
    $caption = $_POST['caption'];
    $hashtag = $_POST['hashtag'];

    // Update the post data in the post table
    $update_post_sql = "UPDATE post SET first_name='$first_name', last_name='$last_name', email='$email', msg='$msg', file='$file' WHERE id='$post_id'";
    if (mysqli_query($conn, $update_post_sql)) {
        echo "<div class='alert alert-success'>Post updated successfully.</div>";
    } else {
        echo "<div class='alert alert-danger'>Error updating post: " . mysqli_error($conn) . "</div>";
    }

    // Update the meta data in the meta_post table
    $update_meta_sql = "UPDATE meta_post SET meta_value='$caption' WHERE post_id='$post_id' AND meta_key='caption'";
    mysqli_query($conn, $update_meta_sql);

    $update_meta_sql = "UPDATE meta_post SET meta_value='$hashtag' WHERE post_id='$post_id' AND meta_key='hashtag'";
    mysqli_query($conn, $update_meta_sql);
}

// Retrieve the post details based on the edit_id parameter
if (isset($_GET['edit_id'])) {
    $edit_id = $_GET['edit_id'];

    // Fetch the post details from the database
    $select_sql = "SELECT * FROM post WHERE id='$edit_id'";
    $result = mysqli_query($conn, $select_sql);

    if (mysqli_num_rows($result) > 0) {
        $row = mysqli_fetch_assoc($result);
        $post_id = $row['id'];
        $first_name = $row['first_name'];
        $last_name = $row['last_name'];
        $email = $row['email'];
        $msg = $row['msg'];
        $file = $row['file'];

        // Fetch the caption from the meta_post table
        $caption = '';
        $select_meta_sql = "SELECT meta_value FROM meta_post WHERE post_id='$post_id' AND meta_key='caption'";
        $meta_result = mysqli_query($conn, $select_meta_sql);
        if (mysqli_num_rows($meta_result) > 0) {
            $meta_row = mysqli_fetch_assoc($meta_result);
            $caption = $meta_row['meta_value'];
        }

        // Fetch the hashtag from the meta_post table
        $hashtag = '';
        $select_meta_sql = "SELECT meta_value FROM meta_post WHERE post_id='$post_id' AND meta_key='hashtag'";
        $meta_result = mysqli_query($conn, $select_meta_sql);
        if (mysqli_num_rows($meta_result) > 0) {
            $meta_row = mysqli_fetch_assoc($meta_result);
            $hashtag = $meta_row['meta_value'];
        }

        // Display the form for updating the post
        ?>
        <div class="container mt-4">
            <h2>Edit Post</h2>
            <form method="POST" action="post_update.php
            ---------------------------------------------------------------------
<post.php>

            <?php
include 'database.php';
include "header.php";
?>


<!-- Fetch posts from the database -->
<?php
$sql = "SELECT * FROM post";
$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    echo "<table class='table'>";
    echo "<thead>";
    echo "<tr>";
    echo "<th>Post ID</th>";
    echo "<th>First Name</th>";
    echo "<th>Last Name</th>";
    echo "<th>Email</th>";
    echo "<th>Message</th>";
    echo "<th>File</th>";
    echo "<th>Meta Data</th>";
    echo "<th>Action</th>";

    echo "</tr>";
    echo "</thead>";
    echo "<tbody>";

    while ($row = mysqli_fetch_assoc($result)) {
        $post_id = $row['id'];
        
        $first_name = $row['first_name'];
        $last_name = $row['last_name'];
        $email = $row['email'];
        $msg = $row['msg'];
        $file = $row['file'];

        // Fetch meta data for the post
        $meta_sql = "SELECT meta_key, meta_value FROM meta_post WHERE post_id = $post_id";
        $meta_result = mysqli_query($conn, $meta_sql);

        $meta_data = array();
        if (mysqli_num_rows($meta_result) > 0) {
            while ($meta_row = mysqli_fetch_assoc($meta_result)) {
                $meta_key = $meta_row['meta_key'];
                $meta_value = $meta_row['meta_value'];

                $meta_data[$meta_key] = $meta_value;
            }
        }

        // Display the post details
        echo "<tr>";
        echo "<td>$post_id</td>";
        echo "<td>$first_name</td>";
        echo "<td>$last_name</td>";
        echo "<td>$email</td>";
        echo "<td>$msg</td>";
        echo "<td>";
        $image_extensions = array('.jpg', '.jpeg', '.png', '.gif');
        $file_extension = strtolower(pathinfo($file, PATHINFO_EXTENSION));
        if (in_array($file_extension, $image_extensions)) {
            echo "<img src='$file' alt='File'>";
        } else {
            echo "<a href='$file' target='_blank'>View File</a>";
        }
        
        echo "</td>";

        // Display the meta data
        echo "<td>";
        if (!empty($meta_data)) {
            foreach ($meta_data as $meta_key => $meta_value) {
                echo "<p>$meta_key: $meta_value</p>";
                // echo "<p>$meta_value</p>";
            }
        } else {
            echo "No meta data found.";
        }
        echo "</td>";
        echo "<td>";
        echo "<a href='post_update.php?edit_id=$post_id' class='btn btn-primary'>Edit</a>";
        echo " ";
        echo "<a href='post_delete.php?delete_id=$post_id' class='btn btn-danger' onclick='return confirmDelete()'>Delete</a>"; // Add onclick event for confirmation
        echo "</td>";

        echo "</tr>";
    }

    echo "</tbody>";
    echo "</table>";
} else {
    echo "<p>No posts found.</p>";
}

mysqli_close($conn);
?>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
<script>
    function confirmDelete() {
        return confirm("Are you sure you want to delete this post?"); // Display confirmation dialog
    }
</script>
<?php
include "footer.php" ?>

